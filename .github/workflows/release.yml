name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # =============================================================================
  # CLI Build - Build the command-line interface for all platforms
  # =============================================================================
  build-cli:
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build CLI
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package CLI
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../knowhere-${{ github.ref_name }}-${{ matrix.target }}.tar.gz knowhere

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.target }}
          path: knowhere-${{ github.ref_name }}-${{ matrix.target }}.tar.gz

  # =============================================================================
  # GUI Build - Build the Tauri desktop app for all platforms
  # =============================================================================
  build-gui:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target universal-apple-darwin
            artifact_name: Knowhere_universal.dmg
          - platform: ubuntu-22.04
            args: ""
            artifact_name: knowhere_amd64.deb

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: gui
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: gui
          args: ${{ matrix.args }}

      - name: Find and upload macOS DMG
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: gui-macos
          path: gui/src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg

      - name: Find and upload Linux deb
        if: matrix.platform == 'ubuntu-22.04'
        uses: actions/upload-artifact@v4
        with:
          name: gui-linux
          path: |
            gui/src-tauri/target/release/bundle/deb/*.deb
            gui/src-tauri/target/release/bundle/appimage/*.AppImage

  # =============================================================================
  # Create GitHub Release with all artifacts
  # =============================================================================
  release:
    needs: [build-cli, build-gui]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/cli-*/*.tar.gz
            artifacts/gui-macos/*.dmg
            artifacts/gui-linux/*.deb
            artifacts/gui-linux/*.AppImage
          generate_release_notes: true

  # =============================================================================
  # Update Homebrew tap with CLI formula and GUI Cask
  # =============================================================================
  update-homebrew:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source repo
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          # CLI checksums
          SHA256_ARM64_DARWIN=$(shasum -a 256 artifacts/cli-aarch64-apple-darwin/knowhere-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz | awk '{print $1}')
          SHA256_X86_64_DARWIN=$(shasum -a 256 artifacts/cli-x86_64-apple-darwin/knowhere-${{ github.ref_name }}-x86_64-apple-darwin.tar.gz | awk '{print $1}')
          SHA256_X86_64_LINUX=$(shasum -a 256 artifacts/cli-x86_64-unknown-linux-gnu/knowhere-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz | awk '{print $1}')
          
          # GUI checksum (macOS DMG)
          DMG_FILE=$(find artifacts/gui-macos -name "*.dmg" | head -1)
          SHA256_DMG=$(shasum -a 256 "$DMG_FILE" | awk '{print $1}')
          DMG_FILENAME=$(basename "$DMG_FILE")

          echo "sha256_arm64_darwin=$SHA256_ARM64_DARWIN" >> $GITHUB_OUTPUT
          echo "sha256_x86_64_darwin=$SHA256_X86_64_DARWIN" >> $GITHUB_OUTPUT
          echo "sha256_x86_64_linux=$SHA256_X86_64_LINUX" >> $GITHUB_OUTPUT
          echo "sha256_dmg=$SHA256_DMG" >> $GITHUB_OUTPUT
          echo "dmg_filename=$DMG_FILENAME" >> $GITHUB_OUTPUT

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare Homebrew files
        run: |
          mkdir -p homebrew-files/Formula
          mkdir -p homebrew-files/Casks

          # Generate CLI Formula
          cat > homebrew-files/Formula/knowhere.rb << 'FORMULA_EOF'
          class Knowhere < Formula
            desc "A lightweight SQL engine for querying CSV and Parquet files via TUI"
            homepage "https://github.com/saivarunk/knowhere"
            version "${{ steps.version.outputs.version }}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/saivarunk/knowhere/releases/download/${{ github.ref_name }}/knowhere-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.sha256_arm64_darwin }}"
              end

              on_intel do
                url "https://github.com/saivarunk/knowhere/releases/download/${{ github.ref_name }}/knowhere-${{ github.ref_name }}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.sha256_x86_64_darwin }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/saivarunk/knowhere/releases/download/${{ github.ref_name }}/knowhere-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.sha256_x86_64_linux }}"
              end
            end

            def install
              bin.install "knowhere"
            end

            test do
              assert_match "knowhere", shell_output("#{bin}/knowhere --version")
            end
          end
          FORMULA_EOF

          # Generate GUI Cask
          cat > homebrew-files/Casks/knowhere.rb << 'CASK_EOF'
          cask "knowhere" do
            version "${{ steps.version.outputs.version }}"
            sha256 "${{ steps.checksums.outputs.sha256_dmg }}"

            url "https://github.com/saivarunk/knowhere/releases/download/${{ github.ref_name }}/${{ steps.checksums.outputs.dmg_filename }}"
            name "Knowhere"
            desc "SQL engine for querying CSV, Parquet, Delta Lake files"
            homepage "https://github.com/saivarunk/knowhere"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "Knowhere.app"

            zap trash: [
              "~/Library/Application Support/com.knowhere.app",
              "~/Library/Preferences/com.knowhere.app.plist",
              "~/Library/Caches/com.knowhere.app",
              "~/knowhere",
            ]
          end
          CASK_EOF

      - name: Push to Homebrew tap
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        with:
          source-directory: "homebrew-files"
          destination-github-username: "saivarunk"
          destination-repository-name: "homebrew-knowhere"
          target-branch: main
          commit-message: "Update knowhere to ${{ github.ref_name }}"
          user-name: github-actions[bot]
          user-email: github-actions[bot]@users.noreply.github.com
